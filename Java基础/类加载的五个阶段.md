# 类加载的五个阶段

![image-20211126111343067](image-20211126111343067.png)

## 加载阶段

+ JVM在该阶段的主要目的是将字节码从不同的数据源（可能是class文件、也可能是jar包、甚至网络）**转化为二进制字节流加载到内存中**，并生成一个代表该类的java.lang.Class对象）

  转化为二进制字节流加载到内存中：这句话指的就是 会将某个类的二进制数据加载到方法区，同时要生成一个class类对象。

## 验证阶段

1. 目的是为了确保Class文件的字节流中包含的信息符合当前虚拟机的要求，并且不会危害虚拟机的自身安全。

2. 包括：文件格式验证（是否以魔数 oxcafebabe开头）、元数据验证、字节码验证和符号引用验证。

3. 可以考虑使用  -Xverify:none 参数来关闭大部分的类验证措施，缩短虚拟机类加载的时间。

   ```java
   //属性-成员变量-字段
   //类加载阶段的链接-准备  属性如何处理
   //1. n1 是实例属性，不是静态变量，因此在准备阶段，是不会分配内存的。
   //2. n2 是静态变量，分配内存 n2 是默认初始化0； 要给n2赋值是后面初始化阶段的事情了。
   //3. n3 是static final 是常量，它和静态变量不一样，因为一旦赋值就不变 n3 = 30
   public int n1 = 10;
   public static int n2 = 20;
   public static int n3 = 30;
   ```

## 链接阶段 - 解析

1. 虚拟机将常量池的符号引用替换为直接引用的过程

   之前一个类引用另一个类是根据名字来的，后面就直接替换为根据内存里面地址来引用了。



## Initialization(初始化)

1. 到初始化阶段，才正真开始执行类中定义的java程序代码，此阶段是执行<clinit>()方法的过程。
2. <clinit>（）方法是由编译器按语句在源文件中出现的顺序，依次自动收集类中的所有**静态变量**的赋值动作和静态代码块中的语句，并进行合并。
3. 虚拟机会保证一个类<clinit>() 方法在多线程环境中被正确的加锁、同步，如果多个线程同时去初始化一个类，那么只有一个线程去执行这个类的<clinit>()方法，其他线程都需要阻塞等待，直到活动线程执行<clinit>()方法完毕。